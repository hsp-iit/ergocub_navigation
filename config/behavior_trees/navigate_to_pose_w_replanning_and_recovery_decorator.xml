<!--
 Copyright (C) 2023 Fondazione Istituto Italiano di Tecnologia (IIT)
 All Rights Reserved.
-->

<!--
  This Behavior Tree replans the global path periodically at 1 Hz and it also has
  recovery actions specific to planning / control as well as general system issues.
  This will be continuous if a kinematically valid planner is selected.
-->
<root BTCPP_format="4" main_tree="MainTree">
  <BehaviorTree ID="MainTree">
    <ReactiveFallback name="MainFallback">
      <GoalReachedConditionModded goal="{goal}"
                                  global_frame="map"
                                  robot_base_frame="geometric_unicycle"/>

      <RecoveryNode number_of_retries="3" name="NavigateRecovery">
        <PipelineSequence name="NavigateWithReplanning">

          <RateController hz="10.0">
            <RecoveryNode number_of_retries="3" name="ComputePathToPose">

              <DecoratorOnBool service_name="is_on_double_support_srv">
                <ComputePathToPose goal="{goal}"
                                   path="{path}"
                                   planner_id="GridBased"/>
              </DecoratorOnBool>

              <ClearEntireCostmap name="ClearGlobalCostmap-Context"
                                  service_name="global_costmap/clear_entirely_global_costmap"/>
            </RecoveryNode>
          </RateController>

          <RecoveryNode number_of_retries="3" name="FollowPath">
            <FollowPath path="{path}"
                        controller_id="FollowPath"/>

            <ClearEntireCostmap name="ClearLocalCostmap-Context"
                                service_name="local_costmap/clear_entirely_local_costmap"/>
          </RecoveryNode>

        </PipelineSequence>

        <ReactiveFallback name="RecoveryFallback">
          <GoalUpdated/>

          <RoundRobin name="RecoveryActions">
            <Sequence name="ClearingActions">
              <ClearEntireCostmap name="ClearLocalCostmap-Subtree"
                                  service_name="local_costmap/clear_entirely_local_costmap"/>

              <ClearEntireCostmap name="ClearGlobalCostmap-Subtree"
                                  service_name="global_costmap/clear_entirely_global_costmap"/>
            </Sequence>
          </RoundRobin>

        </ReactiveFallback>

      </RecoveryNode>
    </ReactiveFallback>
  </BehaviorTree>


  <TreeNodes>
    <Decorator ID="DecoratorOnBool">
      <input_port name="service_name"
                  type="std::string"
                  default_value="is_on_double_support_srv"/>
    </Decorator>

    <Condition ID="GoalReachedConditionModded">
      <input_port name="goal"
                  type="geometry_msgs::msg::PoseStamped"/>
      <input_port name="global_frame"
                  type="std::string"/>
      <input_port name="robot_base_frame"
                  type="std::string"/>
    </Condition>
  </TreeNodes>
</root>
